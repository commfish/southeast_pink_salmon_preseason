---
title: "SEAK Pink Salmon 2024 Forecast Process"
author: "Sara Miller"
date: "October 19, 2023"
output:
  pdf_document: default
  word_document: default
  # add variable to appendix
  # add AIC to table to see if escapement index should not be included
---
```{r setup, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
library(here)
library(fs)
library(tidyverse)
library(knitr)
library(ggplot2)
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
year.forecast <- "2024_forecast" 
data.directory <- file.path(year.forecast, 'data', '/')
results.directory <- file.path(year.forecast, 'results', '/')
```

```{r data}

fs::dir_ls(here::here(results.directory), regexp = "\\.csv$") %>% 
  set_names(nm = (basename(.) %>% 
                    tools::file_path_sans_ext())) %>%
  map(read_csv) -> tbls_seak

```

# Objective
To forecast the Southeast Alaska (SEAK) pink salmon commercial harvest in 2024. 

# Executive Summary
Forecasts were developed using an approach originally described in Wertheimer et al. (2006), and modified in Orsi et al. (2016) and Murphy et al. (2019), but assuming a log-normal error structure (Miller et al. 2022). This approach is based on a multiple regression model with juvenile pink salmon catch-per-unit-effort (CPUE; a proxy for abundance), temperature data from the Southeast Alaska Coastal Monitoring Survey (SECM; Piston et al. 2021; ISTI20_MJJ) or from satellite sea surface temperature (SST) data (Huang et al. 2017), and some additional biophysical variables (condition (July), energy density (July), average zooplankton total water column (May, June, or July), zooplankton density (May, June, or July), the North Pacific Index (NPI), and the Southeast Alaska (SEAK) pink salmon escapement index; see Appendix A). Based on prior discussions, the index of juvenile abundance (i.e., CPUE) was based on the pooled-species vessel calibration coefficient.

There were 37 individual models considered:

* CPUE-only model (m1); 

* CPUE model with temperature data from the the SECM survey (m2);

* 16 CPUE models with satellite SST data (m3-m18); 

* biophysical variable model based on a backward/forward stepwise regression (m19); 

* CPUE model with the SEAK pink salmon escapement index (m1a); and

* 17 CPUE models with a temperature variable (based on the SECM survey or satellite SST data) and the SEAK pink salmon escapement index (m2a-m18a).

A backward/forward stepwise regression with an alpha value of $p$ < 0.05 was performed on the full model that included CPUE, all the temperature variables, and the additional biophysical variables. Next, the Akaike Information Criterion (AIC values; Burnham and Anderson 1998) for each significant step of the stepwise regression was calculated, to prevent over-parameterization of the model. The model with the lowest AIC value was added as an additional forecasting model (m19) along with the other 36 models. Next, the model performance metrics one-step ahead mean absolute percent error (MAPE) for the last five years (forecast years 2019 through 2023) and for the last ten years (forecast years 2014 through 2023) were used to evaluate the forecast accuracy of the 37 individual models, the AICc values were used to prevent over-parameterization of the model, and the adjusted R-squared values were used to the determine fit. Based upon the performance metrics (5-year MAPE, 10-year MAPE), the AICc values, and significant parameters in the models, and the adjusted R-squared values, model x (a model that included x; Table 1 and Table 2) was the best performing model and a forecast using this model would be in the xxx range with a point estimate of x million fish (80% prediction interval: x to x million fish). 

# Analysis

## Individual, multiple linear regression models
Biophysical variables based on data from Southeast Alaska were used to forecast the harvest of adult pink salmon in Southeast Alaska, one year in advance, using individual, multiple linear regression models (models m1–m19 and models m1a-m18a). The simplest regression model (model m1) consisted of only the predictor variable juvenile pink salmon CPUE $({X_1})$, 17 regression models (models m2-m18) consisted of the predictor variable juvenile pink salmon CPUE $({X_1})$ and a temperature index $({X_2})$, one regression model (model m19) consisted of the predictor variables juvenile pink salmon CPUE, the ISTI temperature variable, zooplankton density in June, and fish condition in July $({X_1}...{X_n})$, one model consisted of predictor variable juvenile pink salmon CPUE $({X_1})$ and the Southeast Alaska escapement index $({X_2})$ (model m1a), and 17 models (models m2a-m18a) consisted of the predictor variable juvenile pink salmon CPUE $({X_1})$, a temperature index $({X_2})$, and the Southeast Alaska escapement index $({X_3})$. The models were structured as

$$E(Y_i) = \hat{\alpha}_i + \hat {\beta}_{1_i}{X_1} + ...\hat{\beta}_{n_i}{X_n}\tag{1}.$$

The temperature index for models m2-m18 and for models m2a-m18a was either the SECM survey Icy Strait temperature Index (ISTI20_MJJ; Murphy et al. 2019) or one of the 16 satellite-derived SST data (Huang et al. 2017). Although the simplest model only contained CPUE (model m1), including temperature data with CPUE has been shown to result in a substantial improvement in the accuracy of model predictions (Murphy et al. 2019). The response variable ($Y$; Southeast Alaska adult pink salmon harvest in millions), CPUE data, and the Southeast Alaska pink salmon index were natural log transformed in the model, but temperature data and zooplankton data were not. The forecast $(\hat{\textit {Y}_{i}})$, and 80% prediction intervals (based on output from program R; R Core Team 2021) from the 37 regression models were exponentiated and bias-corrected (Miller 1984),

$$\hat{F_i} = \rm exp (\hat{\textit {Y}_{\textit i}} + \frac{{\sigma_i}^2}{2}),\tag{2}$$

where ${\hat {F_i}}$ is the preseason forecast (for each model $i$) in millions of fish, and $\sigma_i$ is the variance (for each model $i$).

## Performance metric: One-step ahead MAPE
The model summary results using the performance metric one-step ahead MAPE are shown in Table 3a; the smallest value is the preferred model. The performance metric one-step ahead MAPE was calculated as follows.

1. Estimate the regression parameters at time $t$-1 from data up to time $t$-1.  

2. Make a prediction of ${\hat{Y_t}}$ at time $t$ based on the predictor variables at time $t$ and the estimate of the regression parameters at time $t$-1 (i.e., the fitted regression equation).  

3. Calculate the MAPE based on the prediction of ${\hat{Y_t}}$ at time $t$ and the observed value of ${Y_t}$ at time $t$,

$$\text{MAPE} = |\frac{\rm exp{(\textit Y_{\textit t})} -\rm exp (\hat{\textit Y_{\textit t}} + \frac{{\sigma_t}^2}{2})}{\rm exp (\textit Y_{\textit t})}|.\tag{3}$$

4.	For each individual model, average the MAPEs calculated from the forecasts,
$$\frac{1}{n} \sum_{t=1}^{n} |\frac{\rm exp{(\textit Y_{\textit t})} -\rm exp (\hat{\textit Y_{\textit t}} + \frac{{\sigma_t}^2}{2})}{\rm exp (\textit Y_{\textit t})}|,\tag{4}$$
where $n$ is the number of forecasts in the average (5 forecasts for the 5-year MAPE and 10 forecasts for the 10-year MAPE). For example, to calculate the five year one-step-ahead MAPE for model m1 for the 2022 forecast, use data up through year 2016 (e.g., data up through year 2016 is $t$ -1 and the forecast is for $t$, or year 2017). Then, calculate a MAPE based on the 2017 forecast and the observed pink salmon harvest in 2017 using equation 3. Next, use data up through year 2017 (e.g., data up through year 2017 is $t$ -1 and the forecast is for year 2018; $t$) and calculate a MAPE based on the 2018 forecast and the observed pink salmon harvest in 2018 using equation 3. Repeat this process for each subsequent year through year 2020 to forecast 2021. Finally, average the five MAPEs to calculate a five year one-step-ahead MAPE for model m1. For the 10 year one-step-ahead MAPE for model m1, the process would be repeated, but the first forecast year would be 2012. 


# Results
Based upon the 5-year MAPE, the best performing models were m2, m2a, and m19 and based upon the 10-year MAPE, the best performing models were m3, m3a, m7, m7a, m11, and m11a. When comparing model m2 to model m2a, model m3 to model m3a, model m7 to model m7a, and model 11 to model 11a, the AICc value is lower for models without the escapement index term (m2, m3, m7, m11), the adjusted R-squared value is higher for models without the escapement index term (m2, m3, m7, m11), and the escapement index term is not significant in any of the four models (m2a, m3a, m7a, m11a) at the $p$ < 0.05 significance level. Therefore, only models m2, m3, m7, m11, and m19 should be considered candidate models. 

## Model Diagnostics

# References
Burnham, K. P., and D. R. Anderson (1998) Model Selection and Inference. Springer, New York. 353 pp. 

Cook, R. D. 1977. Detection of influential observations in linear regression. Technometrics 19: 15-18.

Fox, J. and S. Weisburg. 2019. An R Companion to Applied Regression, Third Edition. Thousand Oaks CA: Sage Publications, Inc.

Heinl, S. C., and A. W. Piston. 2009. Standardizing and automating the Southeast Alaska pink salmon escapement index. Alaska Department of Fish and Game, Division of Commercial Fisheries, Regional Information Report No. 1J09-06, Douglas.

Huang, B., P. W. Thorne, V. F. Banzon,, T. Boyer, G. Chepurin, J. H. Lawrimore, M. J. Menne, T. M. Smith, R. S. Vose, and H. M. Zhang. 2017. Extended reconstructed sea surface temperature, version 5 (ERSSTv5): upgrades, validations, and intercomparisons. Journal of Climate 30:8179–8205.

Miller, D. M. 1984. Reducing transformation bias in curve fitting. The American Statistician 38: 124-126.

Miller, S. E., J. M. Murphy, S. C. Heinl, A. W. Piston, E. A. Fergusson, R. E. Brenner, W. W. Strasburger, and J. H. Moss. 2022. Southeast Alaska pink salmon forecasting models. Alaska Department of Fish and Game, Fishery Manuscript No. 22-03, Anchorage.

Murphy, J. M., E. A. Fergusson, A. Piston, A. Gray, and E. Farley.  2019. Southeast Alaska pink salmon growth and harvest forecast models.  North Pacific Anadromous Fish Commission Technical Report No. 15: 75-81.

NOAA Coral Reef Watch (NOAA_DHW_monthly data set). 2022, updated daily. NOAA Coral Reef Watch Version 3.1 Monthly 5km SST and SST Anomaly, NOAA Global Coral Bleaching Monitoring Time Series Data, May 1997-June 2021. College Park, Maryland, USA: NOAA/NESDIS/STAR Coral Reef Watch program. Data set accessed 2022-09-12 at https://coastwatch.pfeg.noaa.gov/erddap/griddap/NOAA_DHW_monthly.html.

NOAA Coral Reef Watch (NOAA_DHW data set). 2022, updated daily. NOAA Coral Reef Watch Daily Near-real-Time Global 5km SST and SST Anomaly, NOAA Global Coral Bleaching Monitoring Time Series Data, July 2021 to July 2022. College Park, Maryland, USA: NOAA/NESDIS/STAR Coral Reef Watch program. Data set accessed 2022-09-12 at https://coastwatch.pfeg.noaa.gov/erddap/griddap/NOAA_DHW.html.

Orsi, J. A., E. A. Fergusson, A. C. Wertheimer, E. V. Farley, and P. R. Mundy. 2016. Forecasting pink salmon production in Southeast Alaska using ecosystem indicators in times of climate change. N. Pac. Anadr. Fish Comm. Bull. 6: 483–499. (Available at https://npafc.org)

Piston, A. W., and S. C. Heinl. 2020. Pink salmon stock status and escapement goals in Southeast Alaska through 2019. Alaska Department of Fish and Game, Special Publication No. 20-09, Anchorage

Piston, A. W., J. Murphy, J. Moss, W. Strasburger, S. C. Heinl, E. Fergusson, S. Miller, A. Gray, and C. Waters. 2021. Operational Plan: Southeast coastal monitoring, 2021. ADF&G, Regional Operational Plan No. ROP.CF.1J.2021.02, Douglas.

R Core Team. 2021. R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL: http://www.r-project.org/index.html 

Ren, Y. Y., L. C. Zhou, L. Yang, P. Y. Liu, B. W. Zhao and H. X. Liu. 2016. Predicting the aquatic toxicity mode of action using logistic regression and linear discriminant analysis, SAR and QSAR in Environmental Research, DOI: 10.1080/1062936X.2016.1229691

Wertheimer A. C., J. A. Orsi, M. V. Sturdevant, and E. A. Fergusson. 2006. Forecasting pink salmon harvest in Southeast Alaska from juvenile salmon abundance and associated environmental parameters. In Proceedings of the 22nd Northeast Pacific Pink and Chum Workshop. Edited by H. Geiger (Rapporteur). Pac. Salmon Comm. Vancouver, British Columbia. pp. 65–72.

Zhang, Z. 2016. Residuals and regression diagnostics: focusing on logistic regression. Annals of Translational Medicine 4: 195. 

\pagebreak

```{r data_a}
tbls_seak$data_used_harvest %>% 
   knitr::kable(format = 'pandoc', caption = 'Annual adult pink salmon harvest data from Southeast Alaska (SEAK; millions of fish), the juvenile pink salmon CPUE data collected from the SECM project for years 1998-2024 (juvenile years 1997 to 2023), and the SEAK pink salmon escapement index.', row.names = F, align="cccc")
```

\pagebreak

```{r data_b}
tbls_seak$data_used_temp %>% 
   knitr::kable(format = 'pandoc', caption = 'Zooplankton density in June, and fish condition index in July for years 1998-2024 (juvenile years 1997 to 2023).', row.names = F, align="cccc", font_size=6)
```

\pagebreak

```{r SummaryMetrics1}
# the following table needs to be updated from the excel sheet or just as R output from model_summary_table2 (not bias corrected)
# model_summary_table_month_year.xlsx
tbls_seak$model_summary_table3a %>% 
   knitr::kable(format = 'pandoc', caption = 'Summary of the 5-year and 10-year one-step ahead MAPEs for the 37 regression models.', row.names = F, align="cccc")
```

\pagebreak

```{r SummaryMetrics2}
# the following table needs to be updated from the excel sheet or just as R output from model_summary_table2 (not bias corrected)
# model_summary_table_month_year.xlsx
tbls_seak$model_summary_table3b %>% 
   knitr::kable(format = 'pandoc', caption = 'Summary of the adjusted R-squared values, and the AICc values for the 37 regression models.', row.names = F, align="ccccc")
```

\pagebreak

# Appendix A
# **Variable definitions**
**CPUEcal:** The average Ln(CPUE+1) for catches in either June or July, whichever month had the highest average in a given year, where effort was a standard trawl haul. The CPUE data was adjusted using calibration factors to account for differences in fishing power among vessels. The last time the CPUEcal variable was incorporated in the forecasting process was the 2023 forecast.

**ISTI20_MJJ:** The average 20-m integrated water column temperature at the eight stations in Icy Strait (Icy Strait and Upper Chatham transects) sampled during the SECM surveys in May, June, and July of each year (in degrees Celsius). The last time the ISTI variable was incorporated in the forecasting process was the 2023 forecast.

**Condition**: The average annual residuals derived from the regression of all paired Ln(weights) and Ln(lengths) for pink salmon collected during SECM sampling since 1997 in June and July. The last time the condition residuals were incorporated in the forecasting process was the 2019 forecast.

**Energy Density**: The average energy content (kJ/g dry weight, determined by bomb calorimetry) of subsamples of juvenile pink salmon captured in June or July of each year. The last time the energy density variables were incorporated in the forecasting process was the 2017 forecast (Wertheimer et al. 2018).

Zooplankton metric (**Average Zooplankton Total Water Column**; ml/m$^3$): The average May, June, or July 333-$\mu$m bongo net standing crop (displacement volume divided by water volume filtered, ml/m$^3$), and index of integrated mesozooplankton to 200-m depth (i.e., May, June, or July average zooplankton total water column). The last time the zooplankton metric variables were incorporated in the forecasting process was the 2017 forecast (Wertheimer et al. 2018).

Zooplankton metric (**zooplankton density**; number/m$^3$): The average density (number/m$^3$) of prey available in May, June, or July; an index computed from total density of six zooplankton taxa typically utilized by planktivorous juvenile salmon in summer (Sturdevant et al. 2004) and present in integrated 333-$\mu$m bongo net samples (June Preferred Prey). The last time the zooplankton metric variables were incorporated in the forecasting process was the 2015 forecast (Wertheimer et al. 2015).

North Pacific Index (**NPI**): June, July, August average of the NPI; a measure of atmospheric air pressure in the GOA thought to affect upwelling and downwelling oceanographic conditions (Trenberth and Hurrell 1994); higher values indicate a relaxation of downwelling along the Alaska coast adjacent to the eastern GOA and a widening of the Alaska Coastal Current. Source: https://climatedataguide.ucar.edu/climate-data/north-pacific-np-index-trenberth-and-hurrell-monthly-and-winter

Southeast Alaska pink salmon index (**esc_index_log**: Annual index of the pink salmon escapement in Southeast Alaska based on peak aerial survey counts (Heinl and Piston 2009; Piston and Heinl 2020).

## Satellite SST variables

**Icy_Strait_SST_May**: The Icy Strait region encompasses waters of Icy Strait from the east end of Lemesurier Island to a line from Point Couverden south to Point Augusta. This variable is the average SST in May. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**Icy_Strait_SST_MJJ:** The Icy Strait region encompasses waters of Icy Strait from the east end of Lemesurier Island to a line from Point Couverden south to Point Augusta. This variable is the average SST in May through July. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**Icy_Strait_SST_AMJ**: The Icy Strait region encompasses waters of Icy Strait from the east end of Lemesurier Island to a line from Point Couverden south to Point Augusta. This variable is the average SST in April through June. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**Icy_Strait_SST_AMJJ**: The Icy Strait region encompasses waters of Icy Strait from the east end of Lemesurier Island to a line from Point Couverden south to Point Augusta. This variable is the average SST in April through July. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**Chatham_SST_May**: The Chatham and Icy Straits region encompasses waters of Chatham and Icy Straits east of Lemesurier Island to Point Couverden, and south to the approximate latitude of 56.025 degrees north (roughly Cape Decision off Kuiu Island). This variable is the average SST in May. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**Chatham_SST_MJJ**: The Chatham and Icy Straits region encompasses waters of Chatham and Icy Straits east of Lemesurier Island to Point Couverden, south to the approximate latitude of 56.025 degrees north (roughly Cape Decision off Kuiu Island). This variable is the average SST in May through July. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**Chatham_SST_AMJ**: The Chatham and Icy Straits region encompasses waters of Chatham and Icy Straits east of Lemesurier Island to Point Couverden, south to the approximate latitude of 56.025 degrees north (roughly Cape Decision off Kuiu Island). This variable is the average SST in April through June. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**Chatham_SST_AMJJ**: The Chatham and Icy Straits region encompasses waters of Chatham and Icy Straits east of Lemesurier Island to Point Couverden, south to the approximate latitude of 56.025 degrees north (roughly Cape Decision off Kuiu Island). This variable is the average SST in April through July. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**NSEAK_SST_May**: The NSEAK region encompasses northern Southeast Alaska from 59.475 to 56.075 degrees north latitude (approximately Districts 9 through 15, and District 13 inside area only; northern Southeast Inside subregion for Southeast Alaska (NSEI)). This variable is the average SST in May. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**NSEAK_SST_MJJ**: The NSEAK region encompasses northern Southeast Alaska from 59.475 to 56.075 degrees north latitude (approximately Districts 9 through 15, and District 13 inside area only; northern Southeast Inside subregion for Southeast Alaska (NSEI)). This variable is the average SST in May through July. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**NSEAK_SST_AMJ**: The NSEAK region encompasses northern Southeast Alaska from 59.475 to 56.075 degrees north latitude (approximately Districts 9 through 15, and District 13 inside area only; northern Southeast Inside subregion for Southeast Alaska (NSEI)). This variable is the average SST in April through June. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**NSEAK_SST_AMJJ**: The NSEAK region encompasses northern Southeast Alaska from 59.475 to 56.075 degrees north latitude (approximately Districts 9 through 15, and District 13 inside area only; northern Southeast Inside subregion for Southeast Alaska (NSEI)). This variable is the average SST in April through July. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**SEAK_SST_May**: The SEAK region encompasses Southeast Alaska from 59.475 to 54.725 degrees north latitude. This variable is the average SST in May. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**SEAK_SST_MJJ**: The SEAK region encompasses northern Southeast Alaska from 59.475 to 54.725 degrees north latitude. This variable is the average SST in May through July. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**SEAK_SST_AMJ**: The SEAK region encompasses Southeast Alaska from 59.475 to 54.725 degrees north latitude. This variable is the average SST in April through June. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

**SEAK_SST_AMJJ**: The SEAK region encompasses Southeast Alaska from 59.475 to 54.725 degrees north latitude. This variable is the average SST in April through July. The last time this variable was incorporated in the forecasting process was the 2023 forecast.

\pagebreak

# Appendix B

```{r SummaryMetrics4}
tbls_seak$model_summary_table1 %>% 
   knitr::kable(format = 'pandoc', caption = 'Parameter estimates for the 37 individual models.', row.names = F, align="cccccc")
```

\pagebreak

```{r forecast_models, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/forecast_models.png"))
```

Figure B1: Bias-corrected forecasts (grey bars) for the 37 regression models with 80% prediction intervals (vertical grey lines). Based upon the performance metrics, the best performing models were model m2, m3, m7, m11, and m19. A horizontal dotted line at 20,00,000 fish is placed on the figure for reference only. The forecast using the base model (x) would be in the weak range with a point estimate of x million fish (80% prediction interval: x to x million fish).
\pagebreak
```{r SummaryMetrics5}
tbls_seak$model_summary_table3c %>% 
   knitr::kable(format = 'pandoc', caption = 'Forecasts (with 80% prediction intervals; Lower and Upper columns) for the Southeast Alaska pink salmon commercial harvest in 2024 based on the 37 individual models.', row.names = F, align="cccccc")
```

\pagebreak

# Appendix C
```{r MAPE_5year, echo=FALSE}
knitr::include_graphics(here(results.directory, "/retro/figs/MAPE_forecasts_5yearMAPE.png"))
```

Figure C1: Southeast pink salmon harvest (millions) by year with forecasts based upon the the best performing models using the 5-year MAPE: models m2, m2a, and m19.

\pagebreak

```{r MAPE_10year, echo=FALSE}
knitr::include_graphics(here(results.directory, "/retro/figs/MAPE_forecasts_10yearMAPE.png"))
```

Figure C2: Southeast pink salmon harvest (millions) by year with forecasts based upon the the best performing models using the 10-year MAPE: models m3, m3a, m7, m7a, m11, and m11a. 
