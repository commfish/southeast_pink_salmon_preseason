---
title: "SEAK Pink Salmon 2024 Forecast Process"
author: "Sara Miller"
date: "October 12, 2023"
output:
  pdf_document: default
  word_document: default
---
```{r setup, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
library(here)
library(fs)
library(tidyverse)
library(knitr)
library(ggplot2)
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
year.forecast <- "2024_forecast" 
data.directory <- file.path(year.forecast, 'data', '/')
results.directory <- file.path(year.forecast, 'results', '/')
```

```{r data}

fs::dir_ls(here::here(results.directory), regexp = "\\.csv$") %>% 
  set_names(nm = (basename(.) %>% 
                    tools::file_path_sans_ext())) %>%
  map(read_csv) -> tbls_seak

```

# Objective
To forecast the Southeast Alaska (SEAK) pink salmon commercial harvest in 2023. 

# Executive Summary
Forecasts were developed using an approach originally described in Wertheimer et al. (2006), and modified in Orsi et al. (2016) and Murphy et al. (2019). We used a similar approach to Murphy et al. (2019), but assumed a log-normal error (Miller et al. 2022). This approach is based on a multiple regression model with juvenile pink salmon catch-per-unit-effort (CPUE; a proxy for abundance) and temperature data from the Southeast Alaska Coastal Monitoring Survey (SECM; Piston et al. 2021) or from satellite sea surface temperature (SST) data (Huang et al. 2017). See the document satellite_SST_process_2024--10_13_2023 for details about the temperature variables. Based on prior discussions, the index of juvenile abundance (i.e., CPUE) was based on the pooled-species vessel calibration coefficient. In addition to the temperature models, a backward/forward stepwise regression with an alpha value of $p$ < 0.05 was performed on some additional biophysical variables (condition (July), energy density (July), average zooplankton total water column, zooplankton density, and the North Pacific Index). Next, the Akaike Information Criterion (AIC values; Burnham and Anderson 1998) for each significant step of the stepwise regression was calculated, to prevent over-parameterization of the model. Next, the model performance metric, one-step ahead mean absolute percent error (MAPE), for the last five years (years 2018 through 2022) and for the last ten years (years 2013 through 2022) was used to evaluate the forecast accuracy of the 19 individual models. Based upon this performance metric, model x11 (a model that included x; Table 1 and Table 2) was the best performing model and a forecast using this model would be in the weak range with a point estimate of x million fish (80% prediction interval: x to x million fish). 

# Analysis

## Individual, multiple linear regression models
Biophysical variables based on data from Southeast Alaska were used to forecast the harvest of adult pink salmon in Southeast Alaska, one year in advance, using individual, multiple linear regression models (models m1–m19). The simplest regression model (model m1) consisted of only the predictor variable juvenile pink salmon CPUE $({X_1})$, while the other 18 regression models consisted of the predictor variable juvenile pink salmon CPUE and a temperature index $({X_2})$, or a model with the predictor variable juvenile pink salmon CPUE, the ISTI temperature variable, zooplankton density in June, and fish condition in July. This model was the best performing model (based on AIC value) from the backward/forward stepwise regression analysis.


$$E(Y_i) = \hat{\alpha}_i + \hat {\beta}_{1_i}{X_1} + ...\hat{\beta}_{n_i}{X_n}.\tag{1}$$

The temperature index was either the SECM survey Icy Strait temperature Index (ISTI; Murphy et al. 2019) or one of the 16 satellite-derived SST data (Huang et al. 2017). Although the simplest model only contained CPUE, including temperature data with CPUE has been shown to result in a substantial improvement in the accuracy of model predictions (Murphy et al. 2019). The response variable ($Y$; Southeast Alaska adult pink salmon harvest in millions) and CPUE data were natural log transformed in the model, but temperature data were not. The forecast $(\hat{\textit {Y}_{i}})$, and 80% prediction intervals (based on output from program R; R Core Team 2021) from the 19 regression models were exponentiated and bias-corrected (Miller 1984),
$$\hat{F_i} = \rm exp (\hat{\textit {Y}_{\textit i}} + \frac{{\sigma_i}^2}{2}),\tag{2}$$

where ${\hat {F_i}}$ is the preseason forecast (for each model $i$) in millions of fish, and $\sigma_i$ is the variance (for each model $i$).

```{r data_a}
tbls_seak$data_used_harvest %>% 
   knitr::kable(format = 'pandoc', caption = 'Annual adult pink salmon harvest data from Southeast Alaska (millions of fish), 1998-2023.', row.names = F)
```

\pagebreak

```{r data_b}
tbls_seak$data_used_temp %>% 
   knitr::kable(format = 'pandoc', caption = 'Juvenile pink salmon CPUE data collected from the SECM project, May satellite sea surface temperature data (°C) from the northern Southeast Alaska region in the juvenile years 1997–2023 (NSEAK_SST_May), and average temperature in the upper 20 m during May through July at 8 stations in Icy Strait (Icy Strait and Upper Chatham transects) in the juvenile years 1997–2023 (ISTI20_MJJ).', row.names = F)
```

## Performance metric: One-step ahead MAPE
The model summary results using the performance metric one-step ahead MAPE are shown in Table 3; the smallest value is the preferred model. The performance metric one-step ahead MAPE was calculated as follows.

1. Estimate the regression parameters at time $t$-1 from data up to time $t$-1.  

2. Make a prediction of ${\hat{Y_t}}$ at time $t$ based on the predictor variables at time $t$ and the estimate of the regression parameters at time $t$-1 (i.e., the fitted regression equation).  

3. Calculate the MAPE based on the prediction of ${\hat{Y_t}}$ at time $t$ and the observed value of ${Y_t}$ at time $t$,

$$\text{MAPE} = |\frac{\rm exp{(\textit Y_{\textit t})} -\rm exp (\hat{\textit Y_{\textit t}} + \frac{{\sigma_t}^2}{2})}{\rm exp (\textit Y_{\textit t})}|.\tag{3}$$

4.	For each individual model, average the MAPEs calculated from the forecasts,
$$\frac{1}{n} \sum_{t=1}^{n} |\frac{\rm exp{(\textit Y_{\textit t})} -\rm exp (\hat{\textit Y_{\textit t}} + \frac{{\sigma_t}^2}{2})}{\rm exp (\textit Y_{\textit t})}|,\tag{4}$$
where $n$ is the number of forecasts in the average (5 forecasts for the 5-year MAPE and 10 forecasts for the 10-year MAPE). For example, to calculate the five year one-step-ahead MAPE for model m1 for the 2022 forecast, use data up through year 2016 (e.g., data up through year 2016 is $t$ -1 and the forecast is for $t$, or year 2017). Then, calculate a MAPE based on the 2017 forecast and the observed pink salmon harvest in 2017 using equation 3. Next, use data up through year 2017 (e.g., data up through year 2017 is $t$ -1 and the forecast is for year 2018; $t$) and calculate a MAPE based on the 2018 forecast and the observed pink salmon harvest in 2018 using equation 3. Repeat this process for each subsequent year through year 2020 to forecast 2021. Finally, average the five MAPEs to calculate a five year one-step-ahead MAPE for model m1. For the 10 year one-step-ahead MAPE for model m1, the process would be repeated, but the first forecast year would be 2012. 
```{r SummaryMetrics1}
# the following table needs to be updated from the excel sheet or just as R output from model_summary_table3 
# model_summary_table_month_year.xlsx
tbls_seak$model_summary_table2 %>% 
   knitr::kable(format = 'pandoc', caption = 'Summary of the adjusted R squared value and the 5-year and 10-year one-step ahead MAPEs for the 18 regression models.', row.names = F)
```

# Results
Based upon the 5-year and 10-year one-step ahead MAPE, the best performing model was model m11. 

## Model Diagnostics


# References
Cook, R. D. 1977. Detection of influential observations in linear regression. Technometrics 19: 15-18.

Fox, J. and S. Weisburg. 2019. An R Companion to Applied Regression, Third Edition. Thousand Oaks CA: Sage Publications, Inc.

Huang, B., P. W. Thorne, V. F. Banzon,, T. Boyer, G. Chepurin, J. H. Lawrimore, M. J. Menne, T. M. Smith, R. S. Vose, and H. M. Zhang. 2017. Extended reconstructed sea surface temperature, version 5 (ERSSTv5): upgrades, validations, and intercomparisons. Journal of Climate 30:8179–8205.

Miller, D. M. 1984. Reducing transformation bias in curve fitting. The American Statistician 38: 124-126.

Miller, S. E., J. M. Murphy, S. C. Heinl, A. W. Piston, E. A. Fergusson, R. E. Brenner, W. W. Strasburger, and J. H. Moss. 2022. Southeast Alaska pink salmon forecasting models. Alaska Department of Fish and Game, Fishery Manuscript No. 22-03, Anchorage.

Murphy, J. M., E. A. Fergusson, A. Piston, A. Gray, and E. Farley.  2019. Southeast Alaska pink salmon growth and harvest forecast models.  North Pacific Anadromous Fish Commission Technical Report No. 15: 75-81.

NOAA Coral Reef Watch (NOAA_DHW_monthly data set). 2022, updated daily. NOAA Coral Reef Watch Version 3.1 Monthly 5km SST and SST Anomaly, NOAA Global Coral Bleaching Monitoring Time Series Data, May 1997-June 2021. College Park, Maryland, USA: NOAA/NESDIS/STAR Coral Reef Watch program. Data set accessed 2022-09-12 at https://coastwatch.pfeg.noaa.gov/erddap/griddap/NOAA_DHW_monthly.html.

NOAA Coral Reef Watch (NOAA_DHW data set). 2022, updated daily. NOAA Coral Reef Watch Daily Near-real-Time Global 5km SST and SST Anomaly, NOAA Global Coral Bleaching Monitoring Time Series Data, July 2021 to July 2022. College Park, Maryland, USA: NOAA/NESDIS/STAR Coral Reef Watch program. Data set accessed 2022-09-12 at https://coastwatch.pfeg.noaa.gov/erddap/griddap/NOAA_DHW.html.

Orsi, J. A., E. A. Fergusson, A. C. Wertheimer, E. V. Farley, and P. R. Mundy. 2016. Forecasting pink salmon production in Southeast Alaska using ecosystem indicators in times of climate change. N. Pac. Anadr. Fish Comm. Bull. 6: 483–499. (Available at https://npafc.org)

Piston, A. W., J. Murphy, J. Moss, W. Strasburger, S. C. Heinl, E. Fergusson, S. Miller, A. Gray, and C. Waters. 2021. Operational Plan: Southeast coastal monitoring, 2021. ADF&G, Regional Operational Plan No. ROP.CF.1J.2021.02, Douglas.

R Core Team. 2021. R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL: http://www.r-project.org/index.html 

Ren, Y. Y., L. C. Zhou, L. Yang, P. Y. Liu, B. W. Zhao and H. X. Liu. 2016. Predicting the aquatic toxicity mode of action using logistic regression and linear discriminant analysis, SAR and QSAR in Environmental Research, DOI: 10.1080/1062936X.2016.1229691

Wertheimer A. C., J. A. Orsi, M. V. Sturdevant, and E. A. Fergusson. 2006. Forecasting pink salmon harvest in Southeast Alaska from juvenile salmon abundance and associated environmental parameters. In Proceedings of the 22nd Northeast Pacific Pink and Chum Workshop. Edited by H. Geiger (Rapporteur). Pac. Salmon Comm. Vancouver, British Columbia. pp. 65–72.

Zhang, Z. 2016. Residuals and regression diagnostics: focusing on logistic regression. Annals of Translational Medicine 4: 195. 

\pagebreak

# Appendix A

```{r SummaryMetrics4}
tbls_seak$model_summary_table1 %>% 
   knitr::kable(format = 'pandoc', caption = 'Parameter estimates for the 19 individual models.', row.names = F)
```

```{r forecast_models, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/forecast_models.png"))
```

Figure A1: Bias-corrected forecasts (grey bars) for the eighteen regression models with 80% prediction intervals (blue lines). Based upon the performance metrics, the best performing model was model x; a model that included CPUE and a May temperature index based on northern Southeast Alaska satellite sea surface temperature (SST) data. As the pink salmon forecasting group is still investigating the use of satellite SST as a covariate in the model, the base model, m2 (a model that included CPUE and the average temperature in the upper 20 m during May through July at 8 stations in Icy Strait (Icy Strait and Upper Chatham transects; ISTI20_MJJ)), was used to forecast the SEAK pink salmon harvest in 2024. The forecast using the base model (x) would be in the weak range with a point estimate of x million fish (80% prediction interval: x to x million fish).

# Appendix B
```{r MAPE1, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/MAPE_forecasts.png"))
```

Figure B1: A. SEAK pink salmon harvest (millions) by year with forecasts for models m1 (CPUE only model), m2 (a model that includes CPUE and the average temperature in the upper 20 m during May through July in Icy Strait), and m11 (a model that includes CPUE and a May temperature index based on northern Southeast Alaska satellite SST data) for the last ten years. 

```{r MAPE2, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_1.png"))
```

Figure B2: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2022 forecasts (points) based on the data from years 1998 through 2021.

```{r MAPE3, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_2.png"))
```

Figure B3: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2021 forecasts (points) based on the data from years 1998 through 2020.

```{r MAPE4, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_3.png"))
```

Figure B4: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2020 forecasts (points) based on the data from years 1998 through 2019.

```{r MAPE5, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_4.png"))
```

Figure B5: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2019 forecasts (points) based on the data from years 1998 through 2018.

```{r MAPE6, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_5.png"))
```

Figure B6: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2018 forecasts (points) based on the data from years 1998 through 2017.

```{r MAPE7, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_6.png"))
```

Figure B7: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2017 forecasts (points) based on the data from years 1998 through 2016.

```{r MAPE8, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_7.png"))
```

Figure B8: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2016 forecasts (points) based on the data from years 1998 through 2015.

```{r MAPE9, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_8.png"))
```

Figure B9: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2015 forecasts (points) based on the data from years 1998 through 2014.

```{r MAPE10, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_9.png"))
```

Figure B10: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2014 forecasts (points) based on the data from years 1998 through 2013.

```{r MAPE11, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/year_minus_10.png"))
```

Figure B11: SEAK pink salmon harvest (millions) by year with the model hindcasts (lines) for models m1, m2, and m11 and the 2013 forecasts (points) based on the data from years 1998 through 2012.

```{r sess_info, echo=FALSE}
#sessionInfo()
```
