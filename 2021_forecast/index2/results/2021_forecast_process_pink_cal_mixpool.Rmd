---
title: "2021 Preseason Pink Salmon Forecast"
subtitle: "pink_cal_mixpool"
author: "Sara Miller, Rich Brenner, Jim Murphy"
date: "November 3, 2020--draft"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---
```{r setup, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
library(here)
library(fs)
library(tidyverse)
library(knitr)
library(ggplot2)
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE, error=FALSE)
year.forecast <- "2021_forecast" 
index <- "index2"
#need to change line 55, 154, 155
data.directory <- file.path(year.forecast, index, 'data', '/')
results.directory <- file.path(year.forecast, index, 'results', '/')

#radio_fates_analysis. R code has the figure code
```

```{r data}

fs::dir_ls(here::here(results.directory), regexp = "\\.csv$") %>% 
  set_names(nm = (basename(.) %>% 
                    tools::file_path_sans_ext())) %>%
  map(read_csv) -> tbls_seak

```

# Objective
To forecast the Southeast Alaska (SEAK) pink salmon harvest in 2021.

# Executive Summary
Forecasts were developed using an approach described in Murphy et al. 2019. A multiple regression model was developed using monthly peak juvenile pink salmon CPUE (standardized catch based on 20 minute trawl set) for the June and July surveys and associated environmental parameters. The model used was:
  
$$E(y) = \alpha + \beta_1{X_1} + \beta_2{X_2} + \beta_3{X_1X_2} + \epsilon,$$

where $y$ is ln(harvest), $\beta_1$ is the coefficient for ln(CPUE+1), $\beta_2$ is the coefficient for the environmental covariate water temperature (i.e., May through July average temperature  in the upper 20 m at eight stations in Icy Strait;'ISTI'), $\beta_3$ is the interaction term, and $\epsilon$ represents the normal error term that is lognormal. 

Leave-one-out cross validation (hindcast) and model performance metrics such as Mean and Median Absolute Percentage Error (MAPE, MEAPE), and mean absolute scaled error (MASE) (Hyndman and Kohler 2006) were then used to evaluate forecast accuracy of alternative models. Statistical analyses were performed with the R Project for Statistical computing version 3.6.3 (R Core Team 2020). 
  
Based on an additive model with CPUE and temperature, the SEAK pink salmon harvest in 2021 is predicted to be in the moderate range with a point estimate of 29.8 million fish (80% prediction interval: 20.1 to 44.1 million fish).

# Analysis
Three hierarchical models were investigated. The full model was:

$$E(y) = \alpha + \beta_1{X_1} + \beta_2{X_2} + \beta_3{X_1X_2},$$

where ${X_1}$ is ln(CPUE+1) and ${X_2}$ is the average temperature in Icy Strait in May, June, and July at eight stations in Icy Strait (Icy Strait and Upper Chatham transects), and $\beta_3$ is the interaction term between CPUE and the temperature indice. In the past, the ISTI variable was the average temperature in the upper 20 m during May through August at eight stations in Icy Strait (Icy Strait and Upper Chatham transects).The regression coefficients CPUE and temperature (ISTI) were significant in the first two models (m1, m2). The interaction term was not significant in model m3 (Table 1). Therefore, only the first two models will be considered further.  
```{r coefficients}
tbls_seak$model_summary_table1 %>% 
   knitr::kable(format = 'pandoc', caption = 'Parameter estimates for the three potential models.', row.names = F)
```

The model summary results using the metrics AICc, MAPE, MEAPE, and MASE (Hyndman and Kohler 2006) are shown in Table 2. For all of these metrics, the smallest value is the preferred model. The difference ($\Delta_i$) between a given model and the model with the lowest AICc value and the metric MASE were the primary statistics for choosing appropriate models in this analysis. Models with AICc$\Delta_i$ $\leq$ 2 have substantial support, those in which 4 $\leq$  AICc$\Delta_i$ $\leq$  7 have considerably less support, and models with AICc$\Delta_i$ > 10 have essentially no support (Burnham and Anderson 2004). These two metrics (AICc, MASE) suggest that model m2 is the preferred models. If temperature is actually altering how CPUE is related to abundance it makes sense to restrict the temperature data to the CPUE months in the forecast model (June and July). The month of May is included as there are important migratory dynamics prior to the time juveniles are actually sampled in Icy Strait. Model m2 (based on average temperature in May through July) was used to forecast the 2021 pink salmon harvest. 

```{r model_summary}
tbls_seak$model_summary_table2 %>% 
   knitr::kable(format = 'pandoc', caption = 'Summary of model outputs and forecast error measures')
```

```{r relationship, echo=FALSE}
knitr::include_graphics(here(results.directory, "figs/cpue_temp.png"))
```

Figure 1: Relationship between a) ln(CPUE+1) and ln(harvest) and b) temperature in May through July (ISTI) and ln(harvest).


# Results
The best regression model based on AICc, the MASE metric, significant coefficients in the models, and the argument for restricting temperature to the months when CPUE is sampled was model m2 (i.e. the model containing CPUE, and a May through July temperature variable). The adjusted $R^2$ value for model m2 was 0.82 indicating overall a good model fit.

# Conclusion 
The SEAK pink salmon harvest in 2021 is predicted to be in the moderate range with a point estimate of 29.8 million fish (80% prediction interval: 20.1 to 44.1 million fish).
```{r pred, echo=FALSE}
knitr::include_graphics(here(results.directory, "/figs/catch_plot_pred.png"))
```

Figure 2: SEAK harvest (millions) a) by year and b) by the fitted values from model m2. The line in figure b is a one to one line. The predicted 2021 forecast is symbolized as a grey circle with an 80% prediction interval (20.1 to 44.1 million fish) in figure a. 

```{r model_summary_detailed}
tbls_seak$model_summary_table3 %>% 
   knitr::kable(format = 'pandoc', caption = 'Detailed output for model m2. Juvenile year 2012 (year 2013) shows the largest standardized residual.')
```

# References
Burnham, K. P., and Anderson, D. R. 2004. Multimodel inference: Understanding AIC and BIC in model selection. Sociological Methods and Research 33: 261-304.

Hyndman, R. J. and A. B. Koehler. 2006. Another look at measures of forecast accuracy. International Journal of Forecasting 22: 679-688.

Murphy, J. M., E. A. Fergusson, A. Piston, A. Gray, and E. Farley.  2019. Southeast Alaska pink salmon growth and harvest forecast models.  North Pacific Anadromous Fish Commisson Technical Report No. 15: 75-81.


R Core Team. 2020. R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL: http://www.r-project.org/index.html 


```{r sess_info, echo=FALSE}
#sessionInfo()
```
